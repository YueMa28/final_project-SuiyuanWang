---
title: "Mapping fine-scale population using dasymetric method"
author: Suiyuan Wang
subtitle: A case study in Buffalo city, NY
---

# Introduction

Knowledge of the fine-level population distribution is vital for measuring the impacts of socio-economic justice, optimizing resource allocation, and assessing the risks of environmental exposures. The traditional way to get population data is from the census bureau. However, population data released by the census bureau are too coarse and irregular to satisfy the requirements of accurate analysis. To solve the irregular shape and too coarse level problem of census data, we would downscale the census block group level data to census block. As for the method, the dasymetric method would be applied.  The dasymetric method uses locality knowledge to depict the uneven population distribution within zones without assuming even distributions. This volume preserve method disaggregates the population within the source zone to the target zones according to the weighted layer generated by population-related ancillary information to preserve the total population count. The dasymetric method has been evaluated as an effective and feasible way for population disaggregation. Finally, the result will be evaluated comparing with census block data. Overall, this project aims to apply the dasymetric method to disaggregate census data to get fine-level population data using open-source data.

# Materials and methods

```{r, message=F, warning=F}
require(sf)
require(dasymetric)
library(tidyverse)
library(tidycensus)
library(tigris)
options(tigris_use_cache = TRUE)
library(leaflet)
library(kableExtra)
library(piggyback)
library(tmap) 
library(lwgeom)
knitr::opts_chunk$set(cache=TRUE)  # cache the results for quick compiling
```

1. Download data 
* Census boundaries (2020) with population. 
 * Census block population_block
 * Census block group population_bg
* Microsoft building footprint (2018).
* Buffalo zoning data
```{r}
dataurl = "https://github.com/geo511-2022/final_project-SuiyuanWang/releases/download/v1.0.2/Data_GEO511_project.zip"

#tdir=tempdir()
#download.file(dataurl,destfile=file.path(tdir,"temp.zip"))
#unzip(file.path(tdir,"temp.zip"),exdir = tdir) #unzip the compressed folder

download.file(dataurl,"temp.zip")
unzip("temp.zip") #unzip the compressed folder
```

```{r}
landuse <- st_read("Data_GEO511_project/zoning.shp") 
source_geom <- st_read("Data_GEO511_project/census_bg.shp")
target_geom <- st_read("Data_GEO511_project/census_block.shp")
residential_bf <- st_read("Data_GEO511_project/residential_bf.shp")
# Create directory path
#dsn_zoning <- file.path(tdir, "Data_GEO511_project", "zoning.shp")
#dsn_census_bg <- file.path(tdir, "Data_GEO511_project", "census_bg.shp") 
#dsn_census_block <- file.path(tdir, "Data_GEO511_project","census_block.shp") 
#dsn_residential_bf <- file.path(tdir, "Data_GEO511_project","residential_bf.shp") 

# Buffalo city zoning data (Landuse), source (block group), target (block)
#landuse <- st_read(dsn_zoning) 
#source_geom <- st_read(dsn_census_bg)
#target_geom <- st_read(dsn_census_block)
#residential_bf <- st_read(dsn_residential_bf)
# ancillary data (building footprint)
#bf <- st_read("Data_GEO511_project/building.shp")
```
```{r}
#library(RColorBrewer)
#cols <- brewer.pal(7, "YlOrRd")

# plot(dm_pop["Population"],col = alpha(cols, 0.9), main="Buffalo city Population at Census Block Group (2020)")

#tm_shape(source_geom) +
# tm_fill(col = "population", style = "jenks", size = 0.5, title = "Population") +
# tm_layout(title = "Buffalo city Population at Census Block Group (2020)") +
# tmap_mode("view")

#st_crs(bf)
#st_crs(target_geom)
#st_crs(source_geom)
#st_crs(landuse)
```


2. Clean required data

###filter landuse as residential, using residential landuse to filter building footprint
### find [zoning codes](https://data.buffalony.gov/Economic-Neighborhood-Development/Zoning/5843-jknb) related to residential: 
residential_code = c('N-2R', 'N-3R', 'N-4-30', 'N-4-50', 'D-R')
residential <- landuse %>% filter(gcode == residential_code) 

residential_wgs84  <- residential %>%  st_transform(4326) 

#library(sf)
#bf_wgs84 <- poly2nb(st_make_valid(bf))
#residential_wgs84 <- poly2nb(st_make_valid(residential_wgs84))
sf_use_s2(FALSE)

#residential_bf <- st_intersects(bf, residential_wgs84)

#residential_bf

set same projection for geometries. 
```{r dasymetric, warning=FALSE, message=FALSE}
target_geom_wgs84  <- target_geom %>%  st_transform(4326) 
source_geom_wgs84  <- source_geom %>%  st_transform(4326) 

# dasymetric map with landuse information as ancillary data
sf_use_s2(FALSE)

dm_pop = dasymetric_map(target_geom_wgs84, source_geom_wgs84, residential_bf, extensive = "population")

# convert estimation result to integer, and replace NA as 0.
dm_pop[is.na(dm_pop)] <- 0 
dm_pop$population = as.integer(dm_pop$population)
```
6. Evaluating the result by plotting ground truth data and estimation result. Then, calculate R2 and coefficients.
[REFER TO] (https://lukemiller.org/index.php/2012/10/adding-p-values-and-r-squared-values-to-a-plot-using-expression/)
```{r}
#calculate r2 in dm_pop, 'population'(estimate) & 'Population'(ground truth)
mod1 = lm(Population~population, data = dm_pop)
modsum = summary(mod1)
plot(dm_pop$Population, dm_pop$population, type = 'p', las = 1,
		xlab = expression(paste('Census block Population')),
		ylab = 'Estimate population')

#adding the regression line from the linear model
abline(mod1)
```

```{r}
r2 = modsum$adj.r.squared
print(paste("R2 = ", r2))
```

```{r}
modsum$coefficients
```


7. Mapping. We are using `tmap` to show the ground truth and estimation result in a interactive map. By exploring the map, we can easily find the outliner location and discuss the reason.
```{r}
tm_shape(dm_pop) +
  tm_fill(col = c("population", "Population"), 
          style = "jenks", 
          title = c("Estimate_Population", "True_Population")) + 
  tm_facets(ncol = 2, sync = TRUE) +
  tmap_mode("view")
```

# Results

Evaluating the result by plotting ground truth data and estimation result. Then, calculate R2 and coefficients.
[REFER TO] (https://lukemiller.org/index.php/2012/10/adding-p-values-and-r-squared-values-to-a-plot-using-expression/)
```{r}
#calculate r2 in dm_pop, 'population'(estimate) & 'Population'(ground truth)
mod1 = lm(Population~population, data = dm_pop)
modsum = summary(mod1)
plot(dm_pop$Population, dm_pop$population, type = 'p', las = 1,
		xlab = expression(paste('Census block Population')),
		ylab = 'Estimate population')

#adding the regression line from the linear model
abline(mod1)
```

```{r}
r2 = modsum$adj.r.squared
print(paste("R2 = ", r2))
```

```{r}
modsum$coefficients
```

Mapping. We are using `tmap` to show the ground truth and estimation result in a interactive map. By exploring the map, we can easily find the outliner location and discuss the reason.
```{r}
tm_shape(dm_pop) +
  tm_fill(col = c("population", "Population"), 
          style = "jenks", 
          title = c("Estimate_Population", "True_Population")) + 
  tm_facets(ncol = 2, sync = TRUE) +
  tmap_mode("view")
```


# Conclusions

[~200 words]

Clear summary adequately describing the results and putting them in context. Discussion of further questions and ways to continue investigation.

# References

All sources are cited in a consistent manner

